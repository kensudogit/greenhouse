/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Java application project to get you started.
 * For more details on building Java & JVM projects, please refer to https://docs.gradle.org/8.14.2/userguide/building_java_projects.html in the Gradle documentation.
 * This project uses @Incubating APIs which are subject to change.
 */

plugins {
    // Apply the application plugin to add support for building a CLI application in Java.
    id 'application'
}

repositories {
    // Use Maven Central for resolving dependencies.
    mavenCentral()
}

dependencies {
    // This dependency is used by the application.
    implementation 'com.google.guava:guava:32.1.3-jre'
    
    // Spring Framework dependencies
    implementation 'org.springframework:spring-core:5.3.23'
    implementation 'org.springframework:spring-context:5.3.23'
    implementation 'org.springframework:spring-web:5.3.23'
    implementation 'org.springframework:spring-webmvc:5.3.23'
    implementation 'org.springframework:spring-beans:5.3.23'
    implementation 'org.springframework:spring-aop:5.3.23'
    implementation 'org.springframework:spring-jdbc:5.3.23'
    implementation 'org.springframework:spring-tx:5.3.23'
    implementation 'org.springframework:spring-test:5.3.23'
    
    // Spring Security dependencies
    implementation 'org.springframework.security:spring-security-core:5.7.5'
    implementation 'org.springframework.security:spring-security-crypto:5.7.5'
    implementation 'org.springframework.security:spring-security-web:5.7.5'
    implementation 'org.springframework.security:spring-security-config:5.7.5'
    
    // Spring Social dependencies
    implementation 'org.springframework.social:spring-social-core:1.1.4.RELEASE'
    implementation 'org.springframework.social:spring-social-web:1.1.4.RELEASE'
    implementation 'org.springframework.social:spring-social-facebook:1.1.1.RELEASE'
    implementation 'org.springframework.social:spring-social-twitter:1.1.2.RELEASE'
    
    // Spring Integration dependencies
    implementation 'org.springframework.integration:spring-integration-core:5.5.15'
    implementation 'org.springframework.integration:spring-integration-jdbc:5.5.15'
    
    // Joda Time for date/time handling
    implementation 'joda-time:joda-time:2.12.5'
    
    // Database dependencies
    implementation 'com.h2database:h2:2.2.224'
    implementation 'org.apache.commons:commons-dbcp2:2.10.0'
    
    // JSON processing
    implementation 'com.fasterxml.jackson.core:jackson-databind:2.15.2'
    
    // Dependency injection
    implementation 'javax.inject:javax.inject:1'
    
    // JUnit dependencies for testing
    testImplementation 'junit:junit:4.13.2'
    testImplementation 'org.mockito:mockito-core:4.11.0'
    testImplementation 'org.springframework:spring-test:5.3.23'
    testImplementation 'org.springframework.security:spring-security-test:5.7.5'
    testImplementation 'org.hamcrest:hamcrest-core:2.2'
    testImplementation 'org.hamcrest:hamcrest-library:2.2'
}

testing {
    suites {
        // Configure the built-in test suite
        test {
            // Use JUnit4 test framework
            useJUnit('4.13.2')
            
            // Enable debug information for tests
            targets {
                all {
                    testTask.configure {
                        // Enable detailed logging
                        logging.captureStandardOutput(LogLevel.INFO)
                        logging.captureStandardError(LogLevel.INFO)
                        
                        // Enable test execution logging
                        testLogging {
                            events 'started', 'passed', 'skipped', 'failed'
                            showStandardStreams = true
                            showExceptions = true
                            showCauses = true
                            displayGranularity = 2
                            
                            // Log test execution details
                            info {
                                events 'started', 'passed', 'skipped', 'failed'
                                displayGranularity = 2
                                showExceptions = true
                                showCauses = true
                            }
                        }
                        
                        // Set system properties for tests
                        systemProperty 'java.awt.headless', 'true'
                        systemProperty 'file.encoding', 'UTF-8'
                        
                        // Set JVM arguments for tests
                        jvmArgs '-Xmx512m', '-Xms256m'
                    }
                }
            }
        }
    }
}

// Apply a specific Java toolchain to ease working on different environments.
java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

application {
    // Define the main class for the application.
    mainClass = 'org.example.App'
}

// Enable debug mode for the entire project (adjusted to avoid daemon issues)
// gradle.startParameter.debug = true

// Configure logging for better debugging (adjusted)
logging.captureStandardOutput(LogLevel.INFO)
logging.captureStandardError(LogLevel.INFO)

// Custom test task with enhanced debugging
task debugTest(type: Test) {
    group = 'verification'
    description = 'Run tests with enhanced debugging information'

    useJUnit()

    // Detailed test logging
    testLogging {
        events 'started', 'passed', 'skipped', 'failed', 'standardOut', 'standardError'
        showStandardStreams = true
        showExceptions = true
        showCauses = true
        displayGranularity = 2
    }

    doFirst {
        def debugPort = findAvailablePort(5005, 5015)
        jvmArgs "-Xdebug", "-Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=${debugPort}"
        println "Debug port allocated: ${debugPort}"
    }

    systemProperty 'org.gradle.debug', 'true'
    systemProperty 'org.gradle.test.debug', 'true'
    systemProperty 'org.gradle.logging.level', 'debug'
}

// Helper function to find available port
def findAvailablePort(int startPort, int endPort) {
    for (int port = startPort; port <= endPort; port++) {
        try {
            new java.net.ServerSocket(port).close()
            return port
        } catch (IOException e) {
            // Port is in use, try next
        }
    }
    throw new RuntimeException("No available ports found between ${startPort} and ${endPort}")
}

// Configure the default test task to inherit debug settings
test {
    testLogging {
        events 'started', 'passed', 'skipped', 'failed', 'standardOut', 'standardError'
        showStandardStreams = true
        showExceptions = true
        showCauses = true
        displayGranularity = 2
    }
    
    // Set system properties for tests
    systemProperty 'java.awt.headless', 'true'
    systemProperty 'file.encoding', 'UTF-8'
    
    // Set JVM arguments for tests
    jvmArgs '-Xmx512m', '-Xms256m'
    
    // Enable parallel test execution
    maxParallelForks = Runtime.runtime.availableProcessors().intdiv(2) ?: 1
}

// Task to run all tests with detailed output
task testAll {
    group = 'verification'
    description = 'Run all tests with detailed output'
    dependsOn test
}

// Task to run specific test classes
task listTestClasses {
    group = 'verification'
    description = 'List available test classes'
    
    doLast {
        println "Available test classes:"
        println "- GreenhousePasswordEncoderTest"
        println "- AccountUtilsTest"
        println "- GenderTest"
        println "- EmailAlreadyOnFileExceptionTest"
        println "- SlugUtilsTest"
        println "- EmailUtilsTest"
        println "- ImageUtilsTest"
        println "- EventTest"
        println ""
        println "Usage: gradlew test --tests 'ClassName'"
    }
}
